# Copilot Instructions - Family Games Project

## Informaci√≥n General del Proyecto

Este es un proyecto de **juegos familiares multijugador** que consiste en una aplicaci√≥n m√≥vil React Native con Expo Router y un servidor Node.js con Express y Socket.IO. **Arquitectura modular dise√±ada para m√∫ltiples juegos**.

### Arquitectura

- **Frontend**: React Native + Expo Router + Socket.IO Client
- **Backend**: Node.js + Express + Socket.IO + Prisma + MySQL
- **Base de Datos**: MySQL con Prisma ORM
- **Comunicaci√≥n**: WebSockets (Socket.IO) para tiempo real
- **Estado**: Zustand para gesti√≥n de estado global
- **Navegaci√≥n**: Expo Router (file-based routing)
- **Patr√≥n**: **Modular Multi-Game Architecture** con l√≥gica compartida y espec√≠fica separada

### Principios de Dise√±o

- **Separaci√≥n de responsabilidades**: L√≥gica compartida vs espec√≠fica de cada juego
- **Escalabilidad**: F√°cil agregar nuevos juegos sin afectar existentes
- **Reutilizaci√≥n**: Componentes, hooks y servicios reutilizables
- **Mantenibilidad**: C√≥digo organizado en m√≥dulos independientes

## Estructura del Proyecto

### Frontend (Mobile App - React Native) - Arquitectura Modular

```
frontend/
‚îú‚îÄ‚îÄ app/                        # üì± RUTAS (Expo Router)
‚îÇ   ‚îú‚îÄ‚îÄ _layout.js             # Layout principal
‚îÇ   ‚îú‚îÄ‚îÄ index.js               # Pantalla inicial
‚îÇ   ‚îú‚îÄ‚îÄ auth/                  # üîê AUTENTICACI√ìN
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.js           # Login/registro
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile.js         # Perfil de usuario
‚îÇ   ‚îú‚îÄ‚îÄ lobby/                 # üè† LOBBY GENERAL
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js           # Selecci√≥n de juego
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rooms.js           # Lista de salas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ leaderboard.js     # Rankings generales
‚îÇ   ‚îî‚îÄ‚îÄ games/                 # üéÆ JUEGOS ESPEC√çFICOS
‚îÇ       ‚îú‚îÄ‚îÄ _layout.js         # Layout para juegos
‚îÇ       ‚îú‚îÄ‚îÄ bingo/             # Juego de bingo
‚îÇ       ‚îú‚îÄ‚îÄ cards/             # üÉè JUEGOS DE CARTAS (futuro)
‚îÇ       ‚îî‚îÄ‚îÄ puzzle/            # üß© ROMPECABEZAS (futuro)
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ shared/                # üîÑ L√ìGICA COMPARTIDA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ socket/            # Cliente Socket.IO y eventos base
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/        # Componentes reutilizables (UI, game, chat, lobby)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/             # Hooks compartidos (useSocket, useAuth, useRoom)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/          # Servicios (API, storage, avatarCache, stats)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/             # Estado global Zustand (auth, room, game, ui)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/             # Utilidades compartidas
‚îÇ   ‚îî‚îÄ‚îÄ games/                 # üéÆ L√ìGICA ESPEC√çFICA DE JUEGOS
‚îÇ       ‚îú‚îÄ‚îÄ gameInterface.js   # Interface base para juegos
‚îÇ       ‚îî‚îÄ‚îÄ bingo/             # Implementaci√≥n espec√≠fica del bingo
‚îî‚îÄ‚îÄ assets/                    # Recursos organizados por juego
```

### Backend (Server - Node.js) - Arquitectura Modular

```
backend/
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ index.js               # Servidor principal (inicializaci√≥n)
‚îÇ   ‚îú‚îÄ‚îÄ app.js                 # Configuraci√≥n Express
‚îÇ   ‚îú‚îÄ‚îÄ socketHandler.js       # Handler principal Socket.IO
‚îÇ   ‚îú‚îÄ‚îÄ core/                  # üîß L√ìGICA COMPARTIDA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roomManager.js     # Gesti√≥n de salas gen√©rica
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playerManager.js   # Gesti√≥n de jugadores
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gameRegistry.js    # Registro de juegos disponibles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socketEvents.js    # Eventos socket compartidos
‚îÇ   ‚îú‚îÄ‚îÄ shared/                # üîÑ SERVICIOS COMPARTIDOS
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/          # statsService, avatarService, chatService
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/        # auth, validation, compression
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/             # logger, constants, helpers
‚îÇ   ‚îî‚îÄ‚îÄ games/                 # üéÆ JUEGOS ESPEC√çFICOS
‚îÇ       ‚îú‚îÄ‚îÄ gameInterface.js   # Interface base para juegos
‚îÇ       ‚îú‚îÄ‚îÄ bingo/             # Implementaci√≥n completa del bingo
‚îÇ       ‚îú‚îÄ‚îÄ cards/             # üÉè JUEGOS DE CARTAS (futuro)
‚îÇ       ‚îî‚îÄ‚îÄ puzzle/            # üß© ROMPECABEZAS (futuro)
‚îú‚îÄ‚îÄ prisma/                    # Schema actualizado para m√∫ltiples juegos
‚îî‚îÄ‚îÄ config/                    # Configuraci√≥n modular
```

## Tecnolog√≠as y Dependencias Principales

### Frontend

- **React Native**: 0.79.5
- **Expo**: ^53.0.0
- **Expo Router**: ~5.1.5 (file-based routing)
- **Socket.IO Client**: ^4.7.5
- **Zustand**: ^5.0.8 (estado global)
- **Expo Audio**: ^0.4.8 (sonidos del juego)
- **AsyncStorage**: 2.1.2 (persistencia local)
- **Expo Image Picker**: ~16.1.4 (avatares)
- **Fuentes**: Montserrat, Mukta

### Backend

- **Node.js** + **Express**: ^4.18.2
- **Socket.IO**: ^4.7.5
- **Prisma**: ^6.15.0 (ORM)
- **MySQL**: Base de datos
- **Sharp**: ^0.34.3 (procesamiento im√°genes)
- **Nanoid**: ^5.0.7 (IDs √∫nicos)
- **CORS**: ^2.8.5

## Patrones y Convenciones

### Arquitectura General
1. **Separaci√≥n Modular**: L√≥gica compartida en `/shared/` y `/core/`, espec√≠fica en `/games/`
2. **Interface Pattern**: Todos los juegos implementan `GameInterface` base
3. **Registry Pattern**: Juegos registrados en `gameRegistry.js` con metadatos
4. **Factory Pattern**: Creaci√≥n de instancias de juegos mediante registry
5. **Observer Pattern**: Eventos Socket.IO para comunicaci√≥n tiempo real

### Frontend
1. **Navegaci√≥n**: Expo Router con estructura de archivos modular
2. **Componentes**: Funcionales con hooks, separados por responsabilidad
3. **Estado Global**: Zustand stores modulares (auth, room, game, ui)
4. **Socket Events**: Centralizados en `/shared/socket/` con eventos base y espec√≠ficos
5. **Estilos**: StyleSheet consistente, tema centralizado
6. **Assets**: Organizados por juego en subcarpetas

### Backend
1. **Modular Architecture**: Separaci√≥n clara entre l√≥gica compartida y espec√≠fica
2. **Game Interface**: Todos los juegos extienden clase base `GameInterface`
3. **Room Management**: Gesti√≥n de salas gen√©rica reutilizable para todos los juegos
4. **Socket Events**: Eventos base compartidos + eventos espec√≠ficos por juego
5. **Validation**: Validaciones gen√©ricas + espec√≠ficas por juego
6. **Database**: Schema normalizado para m√∫ltiples juegos
7. **Error Handling**: Logging centralizado con contexto por m√≥dulo

### Comunicaci√≥n entre M√≥dulos
1. **Dependency Injection**: Servicios inyectados en lugar de imports directos
2. **Event-Driven**: Comunicaci√≥n via eventos para desacoplamiento
3. **Interface Contracts**: Contratos claros entre m√≥dulos compartidos y espec√≠ficos

### Comunicaci√≥n Socket.IO

#### Eventos Principales del Cliente

- `listRooms`: Listar salas disponibles
- `createRoom`: Crear nueva sala
- `joinRoom`: Unirse a sala
- `leaveRoom`: Salir de sala
- `startGame`: Iniciar partida (solo host)
- `claim`: Reclamar figura en bingo
- `sendChatMessage`: Enviar mensaje de chat
- `getStats`: Obtener estad√≠sticas
- `updateProfile`: Actualizar perfil de usuario

#### Eventos del Servidor

- `rooms`: Lista de salas actualizada
- `state`: Estado de la sala actualizado
- `ball`: Nueva bola cantada
- `announcement`: Anuncio de figura completada
- `gameOver`: Fin de partida
- `chatMessage`: Mensaje de chat recibido

## Flujo de Juego (Bingo)

1. **Login**: Usuario ingresa nombre y selecciona avatar
2. **Lobby**: Lista de salas, crear nueva o unirse a existente
3. **Configuraci√≥n**: Host configura cartones por jugador (1-4)
4. **Inicio**: Host inicia partida, se generan cartones
5. **Juego**: Sorteo autom√°tico con velocidades configurables
6. **Validaci√≥n**: Server valida figuras reclamadas
7. **Anuncios**: Sistema de anuncios individuales con pausa
8. **Fin**: Cart√≥n lleno gana, estad√≠sticas actualizadas

### Figuras de Bingo

- `corners`: Cuatro esquinas
- `row`: Fila completa
- `column`: Columna completa
- `diagonal`: Diagonal completa
- `border`: Borde del cart√≥n
- `full`: Cart√≥n completo (ganador)

### Base de Datos (Prisma Schema) - Multi-Game Support

### Modelos Principales
```prisma
// Metadatos de juegos
model Game {
  gameKey     String   @id
  name        String
  description String?
  minPlayers  Int
  maxPlayers  Int
  isActive    Boolean  @default(true)
  
  GameSessions GameSession[]
  PlayerGameStats PlayerGameStats[]
}

// Sesiones de juego para tracking
model GameSession {
  id          String   @id @default(cuid())
  gameKey     String
  roomId      String
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  winnerId    String?
  config      Json     // Configuraci√≥n espec√≠fica del juego
  
  Game        Game     @relation(fields: [gameKey], references: [gameKey])
  GameMoves   GameMove[]
}

// Movimientos individuales en partidas
model GameMove {
  id            String   @id @default(cuid())
  sessionId     String
  playerId      String
  moveData      Json     // Datos espec√≠ficos del movimiento
  timestamp     DateTime @default(now())
  
  GameSession   GameSession @relation(fields: [sessionId], references: [id])
}

// Jugadores con soporte para m√∫ltiples juegos
model Player {
  username        String   @id
  name            String?
  avatarUrl       String?  @db.LongText
  avatarId        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now())
  PlayerGameStats PlayerGameStats[]
}

// Estad√≠sticas por jugador y juego
model PlayerGameStats {
  playerUsername String
  gameKey        String
  points         Int    @default(0)
  totalGames     Int    @default(0)
  wins           Int    @default(0)
  
  Player         Player @relation(fields: [playerUsername], references: [username])
  Game           Game   @relation(fields: [gameKey], references: [gameKey])
  
  @@unique([playerUsername, gameKey])
}
```

## Estado Global (Zustand) - Arquitectura Modular

### Stores Compartidos
- `authStore.js`: Estado de autenticaci√≥n y perfil de usuario
- `roomStore.js`: Estado de salas y lobby general  
- `gameStore.js`: Estado base com√∫n a todos los juegos
- `uiStore.js`: Estado de interfaz de usuario global
- `chatStore.js`: Estado del sistema de chat

### Stores Espec√≠ficos por Juego
- `games/bingo/store/bingoStore.js`: Estado espec√≠fico del bingo
- `games/bingo/store/bingoUiStore.js`: UI espec√≠fica del bingo
- `games/bingo/store/animationStore.js`: Animaciones del bingo
- `games/cards/store/cardGameStore.js`: Estado de juegos de cartas (futuro)

### Pattern de Stores
```javascript
// Ejemplo de store base
const useGameStore = create((set, get) => ({
  // Estado compartido por todos los juegos
  currentGame: null,
  isInGame: false,
  gameConfig: {},
  
  // Acciones compartidas
  setCurrentGame: (gameKey) => set({ currentGame: gameKey }),
  resetGameState: () => set({ currentGame: null, isInGame: false })
}));

// Stores espec√≠ficos extienden o componen con el base
const useBingoStore = create((set, get) => ({
  // Estado espec√≠fico del bingo
  cards: [],
  drawnNumbers: [],
  figuresClaimed: {},
  
  // Acciones espec√≠ficas del bingo
  markNumber: (cardIndex, number) => { /* l√≥gica espec√≠fica */ }
}));
```

## Funcionalidades Especiales

### Sistema de Avatares

- Compresi√≥n autom√°tica a ~50KB
- Cach√© eficiente por avatarId
- Sincronizaci√≥n entre dispositivos
- Soporte batch para m√∫ltiples avatares

### Chat en Tiempo Real

- Mensajes por sala
- Integrado con Socket.IO
- UI con toasts y panel lateral

### Sistema de Estad√≠sticas

- Puntuaci√≥n por figuras completadas
- Leaderboard global
- Estad√≠sticas por jugador
- Persistencia en MySQL

### Optimizaciones

- Compresi√≥n de im√°genes server-side
- Cach√© de avatares cliente-side
- Limpieza autom√°tica de salas vac√≠as
- Reconexi√≥n autom√°tica de sockets

## Comandos √ötiles

### Frontend

```bash
cd frontend
npm start                    # Desarrollo con Expo
npm run android             # Ejecutar en Android
npx eas update --branch preview-apk  # Actualizaci√≥n OTA
```

### Backend

```bash
cd backend
npm run dev                 # Desarrollo con nodemon
npm start                   # Producci√≥n
npx prisma migrate dev      # Migraci√≥n BD
npx prisma studio          # GUI base de datos
```

## URLs y Configuraci√≥n

### Servidor

- **Desarrollo**: localhost:4000
- **Producci√≥n**: https://familygames.duckdns.org
- **Railway**: https://family-games-backend-production.up.railway.app

### Variables de Entorno

- `DATABASE_URL`: Conexi√≥n MySQL
- `PORT`: Puerto del servidor (default: 4000)
- `CORS_ORIGIN`: Or√≠genes permitidos
- `HOST`: Host del servidor (default: 0.0.0.0)

## Consideraciones de Desarrollo

### Arquitectura Modular
1. **Separaci√≥n de Responsabilidades**: L√≥gica compartida vs espec√≠fica de juegos
2. **Extensibilidad**: F√°cil agregar nuevos juegos implementando `GameInterface`
3. **Reutilizaci√≥n**: Componentes, hooks y servicios reutilizables entre juegos
4. **Mantenibilidad**: C√≥digo organizado en m√≥dulos independientes
5. **Testing**: Testeo independiente por m√≥dulos y juegos

### Comunicaci√≥n y Estado
1. **Tiempo Real**: Socket.IO para sincronizaci√≥n de estado cr√≠tico
2. **Validaci√≥n**: Doble validaci√≥n (client + server) para jugadas
3. **Persistencia**: AsyncStorage para datos locales, MySQL para estad√≠sticas
4. **Estado Global**: Stores modulares para evitar acoplamiento

### Performance y Escalabilidad
1. **Lazy Loading**: Carga bajo demanda de recursos espec√≠ficos por juego
2. **Cach√© Inteligente**: Sistema de cach√© por m√≥dulos y recursos
3. **Room Management**: Arquitectura de salas escalable para m√∫ltiples juegos
4. **Resource Optimization**: Assets y c√≥digo organizados por juego

### Patrones de Expansi√≥n
1. **Game Registry**: Registro centralizado de juegos disponibles
2. **Factory Pattern**: Creaci√≥n de instancias de juegos din√°micamente
3. **Plugin Architecture**: Nuevos juegos como "plugins" independientes
4. **Configuration**: Configuraci√≥n espec√≠fica por juego en archivos separados

### Mejores Pr√°cticas
1. **Interface Consistency**: Todos los juegos implementan interfaces est√°ndar
2. **Error Boundaries**: Errores de un juego no afectan otros
3. **Resource Isolation**: Assets y dependencias aisladas por juego
4. **Documentation**: Documentaci√≥n espec√≠fica por m√≥dulo y juego

## Debugging y Logs

- Console.log para eventos Socket.IO
- Error tracking en try-catch blocks
- Performance logging para compresi√≥n de im√°genes
- Connection status monitoring

---

**Nota**: Este proyecto utiliza una **arquitectura modular multi-juego** optimizada para dispositivos m√≥viles con Expo, comunicaci√≥n WebSocket para experiencia multijugador fluida, y base de datos MySQL para persistencia de estad√≠sticas. La arquitectura est√° dise√±ada para **escalabilidad horizontal** permitiendo agregar nuevos juegos f√°cilmente sin afectar la funcionalidad existente.

## üìã Recursos Adicionales

- **Plan de Refactorizaci√≥n**: Ver `REFACTORING_PLAN.md` para detalles completos de migraci√≥n
- **Game Interface**: Documentaci√≥n de interfaces base para nuevos juegos
- **API Documentation**: Eventos Socket.IO compartidos y espec√≠ficos por juego
